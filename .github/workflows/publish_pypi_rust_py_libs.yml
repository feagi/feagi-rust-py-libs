# Release Workflow - Publish to PyPI

name: Publish to PyPI - Rust Py Libs

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Determine version and validate
        id: version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"  # Strip 'v' prefix
          IS_PRERELEASE="${{ github.event.release.prerelease }}"
          
          # Validate PEP 440 compliance
          echo "üîç Validating version format: $VERSION"
          
          # PEP 440 regex pattern
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(a[0-9]+|b[0-9]+|rc[0-9]+)?(\.post[0-9]+)?(\.dev[0-9]+)?$ ]]; then
            echo "‚ùå ERROR: Version '$VERSION' does not comply with PEP 440"
            echo ""
            echo "Valid PEP 440 formats:"
            echo "  - 0.1.0         (stable release)"
            echo "  - 0.1.0a1       (alpha 1)"
            echo "  - 0.1.0b1       (beta 1)"
            echo "  - 0.1.0rc1      (release candidate 1)"
            echo ""
            echo "Invalid formats:"
            echo "  - 0.1.0-beta1   (wrong separator)"
            echo "  - v0.1.0        (v prefix not allowed)"
            exit 1
          fi
          
          echo "‚úÖ Version format is PEP 440 compliant"
          echo ""
          echo "üì¶ Version: $VERSION"
          echo "üì¶ Pre-release: $IS_PRERELEASE"
          
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=${IS_PRERELEASE}" >> "$GITHUB_OUTPUT"

  linux:
    needs: validate-version
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      matrix:
        platform:
          - runner: ubuntu-22.04
            target: x86_64
          - runner: ubuntu-22.04
            target: x86
          - runner: ubuntu-22.04
            target: aarch64
    steps:
      - uses: actions/checkout@v4
      
      - name: Update Cargo.toml version
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          echo "üìù Updating Cargo.toml version to: $VERSION"
          # Only replace the FIRST occurrence (package version, not dependencies)
          sed -i "0,/^version = /s|^version = .*|version = \"$VERSION\"|" Cargo.toml
          echo "Updated version:"
          grep "^version = " Cargo.toml | head -1
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - name: Configure vendored OpenSSL for aarch64 cross-compilation
        if: matrix.platform.target == 'aarch64'
        shell: bash
        run: |
          echo "Configuring vendored OpenSSL for aarch64 cross-compilation..."
          
          # Temporarily add vendored OpenSSL to Cargo.toml (CI only)
          # maturin-action handles cross-compilation toolchain in Docker container
          echo "" >> Cargo.toml
          echo "# Temporary: vendored OpenSSL for CI cross-compilation" >> Cargo.toml
          echo "[dependencies.openssl-sys]" >> Cargo.toml
          echo 'version = "0.9"' >> Cargo.toml
          echo 'features = ["vendored"]' >> Cargo.toml
          
          echo "‚úÖ Configured vendored OpenSSL for aarch64"
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        env:
          # Set C++11 standard for aarch64 cross-compilation (required by zmq-sys)
          CXXFLAGS: ${{ matrix.platform.target == 'aarch64' && '-std=c++11' || '' }}
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: true
          manylinux: auto
          before-script-linux: |
            if [ "${{ matrix.platform.target }}" = "aarch64" ]; then
              # For aarch64 cross-compilation: install cross-compilation toolchain
              # (vendored OpenSSL configured in previous step)
              if command -v yum >/dev/null 2>&1; then
                yum install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              elif command -v dnf >/dev/null 2>&1; then
                dnf install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              elif command -v microdnf >/dev/null 2>&1; then
                microdnf install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              elif command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              elif command -v apk >/dev/null 2>&1; then
                apk add --no-cache gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              fi
            else
              # For x86_64/x86: install system OpenSSL
              if command -v yum >/dev/null 2>&1; then
                yum install -y openssl-devel pkgconfig
              elif command -v dnf >/dev/null 2>&1; then
                dnf install -y openssl-devel pkgconfig
              elif command -v microdnf >/dev/null 2>&1; then
                microdnf install -y openssl-devel pkgconfig
              elif command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y libssl-dev pkg-config
              elif command -v apk >/dev/null 2>&1; then
                apk add --no-cache openssl-dev pkgconf
              else
                echo "No supported package manager found" >&2
                exit 1
              fi
            fi
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.platform.target }}
          path: dist

  musllinux:
    needs: validate-version
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - runner: ubuntu-22.04
            target: x86_64
          - runner: ubuntu-22.04
            target: x86
          - runner: ubuntu-22.04
            target: aarch64
    steps:
      - uses: actions/checkout@v4
      
      - name: Update Cargo.toml version
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          echo "üìù Updating Cargo.toml version to: $VERSION"
          # Only replace the FIRST occurrence (package version, not dependencies)
          sed -i "0,/^version = /s|^version = .*|version = \"$VERSION\"|" Cargo.toml
          echo "Updated version:"
          grep "^version = " Cargo.toml | head -1
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - name: Configure vendored OpenSSL for aarch64 cross-compilation
        if: matrix.platform.target == 'aarch64'
        shell: bash
        run: |
          echo "Configuring vendored OpenSSL for aarch64 cross-compilation..."
          
          # Temporarily add vendored OpenSSL to Cargo.toml (CI only)
          # maturin-action handles cross-compilation toolchain in Docker container
          echo "" >> Cargo.toml
          echo "# Temporary: vendored OpenSSL for CI cross-compilation" >> Cargo.toml
          echo "[dependencies.openssl-sys]" >> Cargo.toml
          echo 'version = "0.9"' >> Cargo.toml
          echo 'features = ["vendored"]' >> Cargo.toml
          
          echo "‚úÖ Configured vendored OpenSSL for aarch64"
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        env:
          # Set C++11 standard for aarch64 cross-compilation (required by zmq-sys)
          CXXFLAGS: ${{ matrix.platform.target == 'aarch64' && '-std=c++11' || '' }}
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: true
          manylinux: musllinux_1_2
          before-script-linux: |
            if [ "${{ matrix.platform.target }}" = "aarch64" ]; then
              # For aarch64 cross-compilation: install cross-compilation toolchain
              # (vendored OpenSSL configured in previous step)
              if command -v yum >/dev/null 2>&1; then
                yum install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              elif command -v dnf >/dev/null 2>&1; then
                dnf install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              elif command -v microdnf >/dev/null 2>&1; then
                microdnf install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              elif command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              elif command -v apk >/dev/null 2>&1; then
                apk add --no-cache gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              fi
            else
              # For x86_64/x86: install system OpenSSL
              if command -v yum >/dev/null 2>&1; then
                yum install -y openssl-devel pkgconfig
              elif command -v dnf >/dev/null 2>&1; then
                dnf install -y openssl-devel pkgconfig
              elif command -v microdnf >/dev/null 2>&1; then
                microdnf install -y openssl-devel pkgconfig
              elif command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y libssl-dev pkg-config
              elif command -v apk >/dev/null 2>&1; then
                apk add --no-cache openssl-dev pkgconf
              else
                echo "No supported package manager found" >&2
                exit 1
              fi
            fi
        continue-on-error: true
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: wheels-musllinux-${{ matrix.platform.target }}
          path: dist

  windows:
    needs: validate-version
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      matrix:
        platform:
          - runner: windows-latest
            target: x64
          - runner: windows-latest
            target: x86
    steps:
      - uses: actions/checkout@v4
      
      - name: Update Cargo.toml version
        shell: bash
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          echo "üìù Updating Cargo.toml version to: $VERSION"
          # Only replace the FIRST occurrence (package version, not dependencies)
          sed -i "0,/^version = /s|^version = .*|version = \"$VERSION\"|" Cargo.toml
          echo "Updated version:"
          grep "^version = " Cargo.toml | head -1
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          architecture: ${{ matrix.platform.target }}
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: windows-${{ matrix.platform.target }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            windows-${{ matrix.platform.target }}-cargo-deps-
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: true
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-${{ matrix.platform.target }}
          path: dist

  macos:
    needs: validate-version
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      matrix:
        platform:
          - runner: macos-14
            target: aarch64
          - runner: macos-13
            target: x86_64
    steps:
      - uses: actions/checkout@v4
      
      - name: Update Cargo.toml version
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          echo "üìù Updating Cargo.toml version to: $VERSION"
          # Only replace the FIRST occurrence (package version, not dependencies)
          sed -i.bak "0,/^version = /s|^version = .*|version = \"$VERSION\"|" Cargo.toml
          rm -f Cargo.toml.bak
          echo "Updated version:"
          grep "^version = " Cargo.toml | head -1
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: macos-${{ matrix.platform.target }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-${{ matrix.platform.target }}-cargo-deps-
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: true
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.platform.target }}
          path: dist

  sdist:
    needs: validate-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Update Cargo.toml version
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          echo "üìù Updating Cargo.toml version to: $VERSION"
          # Only replace the FIRST occurrence (package version, not dependencies)
          sed -i "0,/^version = /s|^version = .*|version = \"$VERSION\"|" Cargo.toml
          echo "Updated version:"
          grep "^version = " Cargo.toml | head -1
      
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [validate-version, linux, musllinux, windows, macos, sdist]
    # Require core platforms to succeed (musllinux is best-effort)
    if: |
      needs.linux.result == 'success' &&
      needs.windows.result == 'success' &&
      needs.macos.result == 'success' &&
      needs.sdist.result == 'success'
    environment:
      name: pypi
      url: https://pypi.org/project/feagi-rust-py-libs/
    permissions:
      id-token: write
      contents: write
      attestations: write
    steps:
      - uses: actions/checkout@v4

      - name: Determine version and validate
        id: version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"  # Strip 'v' prefix: v0.1.0 ‚Üí 0.1.0
          IS_PRERELEASE="${{ github.event.release.prerelease }}"
          
          # Validate PEP 440 compliance
          echo "üîç Validating version format: $VERSION"
          
          # PEP 440 regex pattern
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(a[0-9]+|b[0-9]+|rc[0-9]+)?(\.post[0-9]+)?(\.dev[0-9]+)?$ ]]; then
            echo "‚ùå ERROR: Version '$VERSION' does not comply with PEP 440"
            echo ""
            echo "Valid PEP 440 formats:"
            echo "  - 0.1.0         (stable release)"
            echo "  - 0.1.0a1       (alpha 1)"
            echo "  - 0.1.0b1       (beta 1)"
            echo "  - 0.1.0rc1      (release candidate 1)"
            echo ""
            echo "Invalid formats:"
            echo "  - 0.1.0-beta1   (wrong separator)"
            echo "  - v0.1.0        (v prefix not allowed in version)"
            exit 1
          fi
          
          echo "‚úÖ Version format is PEP 440 compliant"
          
          # Get package name from Cargo.toml
          PACKAGE_NAME=$(grep '^name = ' Cargo.toml | head -1 | sed 's/name = "\(.*\)"/\1/' | tr '-' '_')
          if [ -z "$PACKAGE_NAME" ]; then
            echo "‚ùå Error: Could not extract package name from Cargo.toml"
            exit 1
          fi
          
          echo ""
          echo "üì¶ Publishing feagi-rust-py-libs"
          echo "  Version: $VERSION"
          echo "  Pre-release: $IS_PRERELEASE"
          echo "  Package: $PACKAGE_NAME"
          
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "package_name=${PACKAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=${IS_PRERELEASE}" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: artifacts

      - name: Prepare distribution directory
        run: |
          mkdir -p dist
          find artifacts -type f \( -name "*.whl" -o -name "*.tar.gz" \) -exec cp {} dist/ \;
          echo "Files in dist directory:"
          ls -la dist/
          
          if [ -z "$(ls -A dist/)" ]; then
            echo "‚ùå Error: No files found in dist directory"
            exit 1
          fi

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: 'dist/*'

      - name: Publish to PyPI
        uses: PyO3/maturin-action@v1
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_PASSWORD_TOKEN }}

      - name: Summary
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          IS_PRERELEASE="${{ needs.validate-version.outputs.is_prerelease }}"
          PACKAGE_NAME="feagi_rust_py_libs"
          
          echo "‚úÖ Successfully published $PACKAGE_NAME==$VERSION to PyPI"
          echo ""
          
          # Check if this is a pre-release
          if [ "$IS_PRERELEASE" = "true" ]; then
            echo "Pre-release installation (explicit version required):"
            echo "  pip install $PACKAGE_NAME==$VERSION"
            echo ""
            echo "Or install latest pre-release:"
            echo "  pip install --pre $PACKAGE_NAME"
          else
            echo "Installation (stable release):"
            echo "  pip install $PACKAGE_NAME"
            echo ""
            echo "Or specific version:"
            echo "  pip install $PACKAGE_NAME==$VERSION"
          fi
          
          echo ""
          echo "üì¶ Published platforms:"
          echo "  - ‚úÖ Linux wheels (x86_64, x86, aarch64)"
          echo "  - ‚ö†Ô∏è  MuslLinux wheels (best effort)"
          echo "  - ‚úÖ Windows wheels (x64, x86)"
          echo "  - ‚úÖ macOS wheels (aarch64, x86_64)"
          echo "  - ‚úÖ Source distribution"
          echo ""
          echo "üîó https://pypi.org/project/$PACKAGE_NAME/$VERSION/"
